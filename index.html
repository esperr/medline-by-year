<html>
<head>
  <meta http-equiv="content-type" content="text/html; charset=utf-8"/>
  <title>PubMed by Year</title>
  <link href="custom.css" rel="stylesheet" type="text/css">
  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
  <style type="text/css">
  @font-face {
    font-family: 'Roboto';
    font-style: normal;
    font-weight: 400;
    src: url(https://fonts.gstatic.com/s/roboto/v15/Fcx7Wwv8OzT71A3E1XOAjvesZW2xOQ-xsNqO47m55DA.woff2) format('woff2');
  }
  </style>

</head>

<!--
Designed and built by Ed Sperr (esperr@uga.edu or ed_sperr@hotmail.com)
-->
<body>
<script type="text/javascript" src="https://canvg.github.io/canvg/rgbcolor.js"></script>
<script type="text/javascript" src="https://canvg.github.io/canvg/StackBlur.js"></script>
<script type="text/javascript" src="https://canvg.github.io/canvg/canvg.js"></script>
<script src="https://ajax.googleapis.com/ajax/libs/jquery/2.2.2/jquery.min.js"></script>
<script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
<script type="text/javascript" src="https://www.gstatic.com/charts/loader.js"></script>

<div class="container">

<div id="topbanner" class="jumbotron">
  <h1>PubMed by Year</h1>
  <a id="about" class="label label-default" href="about.html">About PubMed by Year</a>
</div>

<div class="row">



<div class="col-sm-12 col-md-8 col-lg-9">
<div id="search" class="input-group input-group-lg">
  <input type="text" id="pmsearch" class="form-control">
  <span class="input-group-btn">
    <button id="runsearch" class="btn btn-primary" type="button">Search</button>
  </span>
</div>
</div>

<div class="col-sm-12 col-md-4 col-lg-3">
  <div class="panel panel-default">
    <div class="panel-heading">Year Range</div>
    <div class="panel-body">
      <div id="pickyears"></div>
    </div>
  </div>
</div>

</div><!--row-->

<!--
<div id="printable">
  <div id="printable-stuff">
  <span class="close">Ã—</span>
  </div>
</div>
-->
<div class="row">
<div id="left" class="col-sm-12 col-md-12 col-lg-12">
<div id="results">
<div id="splash" class="panel panel-default splash">
  <div class="panel-body">
    <p>PubMed by Year shows your search proportionally, comparing the results for each year to the database as whole.</p>
    <p>Enter any <a href="https://www.ncbi.nlm.nih.gov/pubmed/">PubMed</a> search above to see how your results change over time.
    You can use one word (e.g. <a class="example" data-srchstr="q1=heart">heart</a>, <a class="example" data-srchstr="q1=diabetes">diabetes</a>) or
    several (<a class="example" data-srchstr="q1=breast cancer">breast cancer</a>, <a class="example" data-srchstr="q1=myocardial infarction">myocardial infarction</a>).
    You can even use more advanced techniques such as field tags (<a class="example" data-srchstr="Leukemia[Mesh]">Leukemia[Mesh]</a>, <a class="example" data-srchstr="q1=pubmednotmedline [sb]">pubmednotmedline [sb]</a>) or
    boolean operators (<a class="example" data-srchstr="q1=smoking AND lung cancer ">smoking AND lung cancer</a>, <a class="example" data-srchstr="q1=polio AND (vaccine OR vaccination)">polio AND (vaccine OR vaccination)</a>).
    Finally, by entering multiple searches one at a time, you can easily <a class="example" data-srchstr="q1=dengue&q2=chikungunya&q3=zika">compare</a> them.
    Once you're finished, you can easily share your results with others or save your graphs for later.

      <em><a href="about.html">(more)</a></em></p>
    </div>
</div>
</div>
</div>

</div><!--row-->


<!--
<div class="col-sm-12 col-md-2 col-lg-3">

<div id="past" class="panel panel-default hideme">
  <div class="panel-heading">
    <h3 class="panel-title">Past searches</h3>
  </div>
  <div class="panel-body">
  </div>
</div>
-->

<div id="sharing-link" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Share this search</h4>
      </div>
      <div class="modal-body">
        <input type="text" id="sharingUrlcontent">
      </div>
      <div class="modal-footer">
        <p>Copy the link above</p>
      </div>
    </div>
  </div>
</div>

<div id="printchart" class="modal modal-wide fade" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
        <h4 class="modal-title">Printable Chart</h4>
      </div>
      <div class="modal-body">
        <canvas id="canvas"></canvas>
      </div>
      <div class="modal-footer">
        <p>Right click on image to save</p>
        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
        <button type="button" id="changesize" class="btn btn-primary">View Larger Size</button>
      </div>
    </div>
  </div>
</div>

<p style='clear: both; margin-bottom: 60px;'></p>
<br />

</div>

<!--
</div>
</div>
-->

<footer class="footer">
  <div class="container">
    <span class="text-muted">  <p>Design and contruction by Ed Sperr, M.L.I.S. (<a href="mailto:ed_sperr@hotmail.com">ed_sperr@hotmail.com</a>)   |
      Data from <a href="http://www.ncbi.nlm.nih.gov/">NCBI</a>  |   Charting tools from  <a href="https://developers.google.com/chart/interactive/docs/gallery/linechart" target="_blank">Google</a>
     | See the code at <a href="https://github.com/esperr/pubmed-by-year">GitHub</a></p></span>
  </div>
</footer>


<script>

(function() {

var searches = { counts:{}, searchterms:[] };
var dataURL = "";
var basecounts = {};

var d = new Date();
var thisYear = d.getFullYear();

var startYear = 1945;
var endYear = thisYear;

var data;
var options;

var printsize = "small";

var currentLocation = location.hostname + location.pathname;
console.log(currentLocation);

//Do we have a search or datespan specified in the querystring?
if (location.search) {
  var queryDict = {};
  location.search.substr(1).split("&").forEach(function(item) {
      queryDict[item.split("=")[0]] = item.split("=")[1]
  })
  querySearch(queryDict);
}


//Fetch our baseline counts from the webservice
$.get( "https://med-by-year.appspot.com/showbasecounts", function( data ) {
  //build out our data structure
  var allCounts = data.counts;
  for (var year in allCounts) {
    searches.counts[year] = { "total": allCounts[year] } ;
  }
  pickYears();
})
.fail(function() {
  alert( "There was some sort of problem -- please reload the page" );
});


//var search = [];
google.charts.load('current', {'packages':['line']});
//google.charts.load('current', {packages: ['corechart', 'line']});


var currentwidth = $("#left").innerWidth() * .9;
var mywidth = 600;
var myheight = 300;
if (currentwidth > mywidth) {
  mywidth = currentwidth;
  myheight = currentwidth*.5;
}

//manually get baseline counts
//term = "all[sb]";
//dosearch(term);
//alert("done!");

function querySearch(queryDict) {
  if (queryDict["startyear"]) { startYear = queryDict["startyear"]; }
  if (queryDict["endyear"]) { endYear = queryDict["endyear"]; }
  for (var search in queryDict) {
    if(search.match(/q/)) {
      term = decodeURIComponent(queryDict[search])
      dosearch(term);
    }
  }
}

function handlesearch() {
  term = $("#pmsearch").val();
  dosearch(term);
  $("#pmsearch").val("");
  document.getElementById('pmsearch').focus();
  }


  window.onpopstate = function(event) {
    //reconstitute earlier searches if the user is going "back"
    if (event.state) {
      searches = event.state["myData"];
      startYear = event.state["startyear"];
      endYear = event.state["endyear"];
      drawMainChart();
    }
  };

function showWait() {
  $( "#pmsearch" ).prop( "disabled", true );
  $( "#runsearch" ).prop( "disabled", true );
  $( "form" ).addClass( "hideme" );
  $("#results").empty();
  $( "#results" ).append("<div id='loading'><p class='text-center'>Grabbing your results &mdash; please wait</p></div>")
  $( "#results p" ).append( '<br /><img src="loading-bars.svg">' );
  }

  function showDone() {
    $( "#pmsearch" ).prop( "disabled", false );
    $( "#runsearch" ).prop( "disabled", false );
    $( "form" ).removeClass( "hideme" );
    $( "#runsearch" ).removeClass( "hideme" );
    $("#loading").remove();
    $("#fetchresults").remove();
    }

  function pickYears() {
    $("#pickyears").empty();
    $("#pickyears").append('Start: <select name="startyear">');
    $("#pickyears").append('&nbsp;&nbsp;End: <select name="endyear">');
    for (var year in searches.counts) {
      if (Number(year) < 1600) { continue; }
      if (Number(year) < endYear) {
        if (year == startYear) {
          $("[name=startyear]").append('<option value="' + year + '" selected="selected">' + year + '</option>');
        } else {
          $("[name=startyear]").append('<option value="' + year + '">' + year + '</option>');
        }
      }
      if (Number(year) > startYear) {
        if (year == endYear) {
          $("[name=endyear]").append('<option value="' + year + '" selected="selected">' + year + '</option>');
        } else {
          $("[name=endyear]").append('<option value="' + year + '">' + year + '</option>');
        }
      }
    }
  }

$(".example").click(function(){
    var searchstr = $( this ).attr("data-srchstr");
     window.open(location.pathname + "?" + searchstr);
    });

$( "#results" ).on( "click", ".printMe", function() {
    getprint();
    });

$( "#results" ).on( "click", ".shareLink", function() {
    $('#sharing-link').modal();
    });

  $( "#pickyears" ).on( "change", "[name=startyear]", function() {
    startYear = Number($("[name=startyear]").val());
    pickYears();
    if (searches.searchterms.length > 0) {
        drawMainChart();
    }
  });

  $( "#pickyears" ).on( "change", "[name=endyear]", function() {
    endYear = Number($("[name=endyear]").val());
    pickYears();
    if (searches.searchterms.length > 0) {
      drawMainChart();
    }
  });

  $( "#results" ).on( "click", "#reset", function() {
    var currentLocation = location.hostname + location.pathname;
    //alert (currentLocation);
    location.replace(currentLocation);
  });

  $( "#changesize" ).click(function() {
    if ( printsize == "small" ) {
      printsize = "large";
    } else {
      printsize = "small";
    }
    getprint();
  });

function dosearch(term) {
  showWait();
  urlstem = "https://med-by-year.appspot.com/search?q=";
  url = urlstem + encodeURIComponent(term);
  console.log(url);
  $.get( url, function( data ) {
    if (data.hasOwnProperty('counts')) {
      searches.searchterms.push(term);
      myCounts = data.counts;
      for (var year in myCounts) {
        searches.counts[year][term] = myCounts[year];
      }
      drawMainChart();
    } else {
      showDone();
      alert("Nothing found for this search or too few results to chart by year. Please try again");
      if (searches.searchterms.length > 0) {
          drawMainChart();
      } else {
        return;
      }
    }
  })
  .fail(function() {
    alert( "There was some sort of problem -- please reload the page" );
  });

  }

$("#runsearch").click(function(){
    handlesearch();
  });

 $(document).keypress(function(e) {
  if(e.which == 13) {
      //Because both IE and FF now "helpfully" ignore the spec and treat 'button' the same as 'submit'
      e.preventDefault();
      handlesearch();
  }
});



function drawMainChart() {
  $("#results").empty();
  showDone();
  if (startYear < 1945) {
    $("#results").append('<div class="alert alert-warning" role="alert">');
    $("#results .alert").append('<strong>Remember:</strong> OLDMEDLINE only goes back to 1946, so results are sparse before then');
  }
  $("#results").append('<p>Search again above to compare results on your chart. Choose "Reset Searches" below to start over.</p>');
  $("#results").append('<p>Hover to see details for a given year. Click to launch a search in PubMed</p>');

  $( "#results" ).append( '<div class="panel panel-default">' );
  $( "#results .panel" ).append( '<div id="chart_div" class="panel-body">' );
  //"hidden" div where we draw the printable chart
  $( "#results" ).append( '<div id="chart_two">' );
  $("#results .panel").after('<button id="reset" type="button" class="btn btn-warning">Reset Searches</button>');

  var myQuerystring = "";
  //var queryDict = {};
  for (i=0; i<searches.searchterms.length; i++) {
    if (myQuerystring.length > 0) { myQuerystring = myQuerystring + "&"; }
    var qindex = i+1;
    //queryDict['q' + qindex.toString()] = searches.searchterms[i];
    var querypart = 'q' + qindex.toString() + '=' + searches.searchterms[i];
    myQuerystring = myQuerystring + querypart;
  }
  if (startYear != 1945) {
    myQuerystring = myQuerystring + "&startyear=" + startYear;
    //queryDict["startyear"] = startYear;
  }
  if (endYear != thisYear) {
    myQuerystring = myQuerystring + "&endyear=" + endYear;
    //queryDict["endyear"] = endYear;
  }
  var shareUrl = currentLocation + "?" +  myQuerystring;
  $( "#sharingUrlcontent" ).attr( "style", "width: 35em;" );
  $( "#sharingUrlcontent" ).attr( "value", shareUrl );
  
  data = new google.visualization.DataTable();
  data.addColumn('string', 'Year');
  for (i = 0; i < searches.searchterms.length; i++) {
    data.addColumn('number', searches.searchterms[i]);
  }


  for (var year in searches.counts) {
    if (Number(year) < startYear) { continue; }
    if (Number(year) > endYear) { continue; }
    theseCounts = [year];
    for (i = 0; i < searches.searchterms.length; i++) {
      var term = searches.searchterms[i];
      var yearTotal = Number(searches.counts[year]["total"]);
      if (searches.counts[year][term]) {
        var proportion = Number(searches.counts[year][term]) / yearTotal;
        construct = {
          v: proportion,
          f: Number(searches.counts[year][term]).toLocaleString() + " citations (out of " + yearTotal.toLocaleString() + " in " + year + ")"
        }
        theseCounts.push(construct);
        //theseCounts.push(proportion);
      } else {
        theseCounts.push(0);
      }
    }
    data.addRow(theseCounts);
  }
  //we clear the address bar...

  history.pushState({ "myData": searches, "startyear": startYear, "endyear": endYear }, "", currentLocation);


  options = {
        chart: {
          title: 'Proportion of citations in PubMed',
          subtitle: 'proportion for each search by year, ' + $("[name=startyear]").val() + ' to ' + $("[name=endyear]").val()
        },
        width: mywidth,
        height: myheight,
        vAxis: {format: 'decimal',
                title: 'proportion'},
      };

  var chart = new google.charts.Line(document.getElementById('chart_div'));

  //Here comes the clicky bit...
  function selectHandler() {
  var selectedItem = chart.getSelection()[0];
  if (selectedItem) {
    var year = data.getValue(selectedItem.row, 0);
    var thisSearchindex = selectedItem['column'];
    var myterm = searches.searchterms[thisSearchindex-1];
    var resultsURL = 'https://www.ncbi.nlm.nih.gov/pubmed/';
    resultsURL = resultsURL + '?term=' + myterm + '+AND+' + year + '[DP]';
    window.open(resultsURL,'_blank');
   }
  }

  google.visualization.events.addListener(chart, 'select', selectHandler);
  chart.draw(data,  google.charts.Line.convertOptions(options));

  $("#chart_div").append('<a href="#!" class="printMe">Printable version</a>');
  $("#chart_div").append('<p>Share this search: <a href="#!" class="shareLink">Link</a></p>');

  }

  function getprint() {
    //$( "#printable img" ).remove();
    $("#chart_two").removeClass( "hideme" );
    if (printsize == "small") {
      width = 600;
      height = 300;
      $("canvas").attr("width", "600");
      $("canvas").attr("height", "330");
      $("#printchart").removeClass("modal-wide");
      $("#printchart").addClass("modal-medium");
      $("#changesize").text("Larger size");
    }
    if (printsize == "large") {
      width = 1200;
      height = 600;
      $("canvas").attr("width", "1200");
      $("canvas").attr("height", "630");
      $("#printchart").removeClass("modal-medium");
      $("#printchart").addClass("modal-wide");
      $("#changesize").text("Smaller size");
    }
    var charttwo = new google.charts.Line(document.getElementById('chart_two'));
    options.width = width;
    options.height = height;
    charttwo.draw(data,  google.charts.Line.convertOptions(options));
    google.visualization.events.addListener(charttwo, 'ready', myReadyHandler);

    function myReadyHandler() {
      var t = $("#chart_two svg")[0];
      var xmlString = (new XMLSerializer).serializeToString(t);
      var canvchart = document.createElement("canvas");
      canvg(canvchart, xmlString, { log: true, ignoreMouse: true, ignoreAnimation: true });
      var c2 = document.createElement("canvas");
      c2.width = width;
      c2.height = height + 40;
      var ctx = c2.getContext('2d');
      ctx.beginPath();
      ctx.rect(0, 0, width, height + 40);
      ctx.fillStyle = "white";
      ctx.fill();
      ctx.font="13px Roboto";
      ctx.fillStyle = "Gray";
      ctx.fillText("Made with MEDLINE by Year: http://esperr.github.io/medline-by-year",0,height + 25);

      //var can = document.getElementById('canvas');
      var can3 = document.getElementById('canvas');
      var ctx3 = can3.getContext('2d');

      ctx3.drawImage(c2, 0, 0);
      ctx3.drawImage(canvchart, 0, 0);
      var newdataURL = c2.toDataURL();
      console.log(newdataURL);
      $("#chart_two").addClass( "hideme" );
      $('#printchart').modal();
      //$("#printable").css("display", "block");
    }

    }

$(".close").click(function(){
  $("#printable").css("display", "none");
      });

$(document).click(function(event) {
   var closeit = document.getElementById('printable');
   if (event.target == closeit) {
      $("#printable").css("display", "none");
      }
      });

function keysrt(arr, key, reverse) {
    var sortOrder = 1;
    if(reverse){
        sortOrder = -1;
    }
    return arr.sort(function(a, b) {
        var x = a[key],
            y = b[key];

        return sortOrder * ((x < y) ? -1 : ((x > y) ? 1 : 0));
    });
}

})

();




</script>
</body>
</html>
